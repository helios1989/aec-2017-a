'use strict';

var Web3 = require('web3');
var web3 = new Web3();
web3.setProvider(new web3.providers.HttpProvider());

class Project {

    // factory method to create new project on blockchain
    static create(name, creator, fundingStart, fundingEnd, fundingGoal) {
        return new Promise((resolve, reject) => {

            this.contract.new(name, fundingStart, fundingEnd, fundingGoal, {
                    from: web3.eth.accounts[creator],
                   // data: '0x6060604052341561000c57fe5b604051610859380380610859833981016040528080518201919060200180519060200190919080519060200190919080519060200190919050505b836000908051906020019061005d9291906100f0565b5033600160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550826005819055508160068190555080600760006101000a8154816fffffffffffffffffffffffffffffffff02191690836fffffffffffffffffffffffffffffffff1602179055505b50505050610195565b828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f1061013157805160ff191683800117855561015f565b8280016001018555821561015f579182015b8281111561015e578251825591602001919060010190610143565b5b50905061016c9190610170565b5090565b61019291905b8082111561018e576000816000905550600101610176565b5090565b90565b6106b5806101a46000396000f30060606040523615610076576000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff16806313e7323e1461007f57806341c0e1b5146100a55780636b45019d146100b75780637a3a0e8414610157578063b60d4288146101a1578063bcde18f1146101ab575b61007d5b5b565b005b341561008757fe5b61008f6101d1565b6040518082815260200191505060405180910390f35b34156100ad57fe5b6100b56101d7565b005b34156100bf57fe5b6100c7610282565b604051808060200183815260200182810382528481815181526020019150805190602001908083836000831461011c575b80518252602083111561011c576020820191506020810190506020830392506100f8565b505050905090810190601f1680156101485780820380516001836020036101000a031916815260200191505b50935050505060405180910390f35b341561015f57fe5b6101676103b4565b60405180826fffffffffffffffffffffffffffffffff166fffffffffffffffffffffffffffffffff16815260200191505060405180910390f35b6101a96103d6565b005b34156101b357fe5b6101bb610491565b6040518082815260200191505060405180910390f35b60065481565b600160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff1614801561023f57506001151561023b610497565b1515145b1561027f57600160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16ff5b5b565b61028a610624565b6000600760009054906101000a90046fffffffffffffffffffffffffffffffff166fffffffffffffffffffffffffffffffff1660045410151561030b57600454604060405190810160405280601e81526020017f46756e64696e6720676f616c20686173206265656e207265616368656421000081525090915091506103b0565b600760009054906101000a90046fffffffffffffffffffffffffffffffff166fffffffffffffffffffffffffffffffff1660045410156103af57600454606060405190810160405280602281526020017f46756e64696e6720676f616c20686173206e6f74206265656e2072656163686581526020017f642100000000000000000000000000000000000000000000000000000000000081525090915091506103b0565b5b9091565b600760009054906101000a90046fffffffffffffffffffffffffffffffff1681565b34600360003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020819055506002805480600101828161042e9190610638565b916000526020600020900160005b33909190916101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555050346004600082825401925050819055505b565b60055481565b6000600060006000600092505b600280549050831015610619576002838154811015156104c057fe5b906000526020600020900160005b9054906101000a900473ffffffffffffffffffffffffffffffffffffffff169150600360008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020549050600081111561060b576000600360008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020819055508173ffffffffffffffffffffffffffffffffffffffff166108fc829081150290604051809050600060405180830381858888f19350505050151561060a5780600360008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020819055506000935061061e565b5b5b82806001019350506104a4565b600193505b50505090565b602060405190810160405280600081525090565b81548183558181151161065f5781836000526020600020918201910161065e9190610664565b5b505050565b61068691905b8082111561068257600081600090555060010161066a565b5090565b905600a165627a7a723058200c961d1dd0803dc39f0ab9f7cb50d2b49bd0b9e98d6be0624f65700f796e2d350029',
                    data: '6060604052341561000c57fe5b604051610859380380610859833981016040528080518201919060200180519060200190919080519060200190919080519060200190919050505b836000908051906020019061005d9291906100f0565b5033600160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550826005819055508160068190555080600760006101000a8154816fffffffffffffffffffffffffffffffff02191690836fffffffffffffffffffffffffffffffff1602179055505b50505050610195565b828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f1061013157805160ff191683800117855561015f565b8280016001018555821561015f579182015b8281111561015e578251825591602001919060010190610143565b5b50905061016c9190610170565b5090565b61019291905b8082111561018e576000816000905550600101610176565b5090565b90565b6106b5806101a46000396000f30060606040523615610076576000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff16806313e7323e1461007f57806341c0e1b5146100a55780636b45019d146100b75780637a3a0e8414610157578063b60d4288146101a1578063bcde18f1146101ab575b61007d5b5b565b005b341561008757fe5b61008f6101d1565b6040518082815260200191505060405180910390f35b34156100ad57fe5b6100b56101d7565b005b34156100bf57fe5b6100c7610282565b604051808060200183815260200182810382528481815181526020019150805190602001908083836000831461011c575b80518252602083111561011c576020820191506020810190506020830392506100f8565b505050905090810190601f1680156101485780820380516001836020036101000a031916815260200191505b50935050505060405180910390f35b341561015f57fe5b6101676103b4565b60405180826fffffffffffffffffffffffffffffffff166fffffffffffffffffffffffffffffffff16815260200191505060405180910390f35b6101a96103d6565b005b34156101b357fe5b6101bb610491565b6040518082815260200191505060405180910390f35b60065481565b600160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff1614801561023f57506001151561023b610497565b1515145b1561027f57600160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16ff5b5b565b61028a610624565b6000600760009054906101000a90046fffffffffffffffffffffffffffffffff166fffffffffffffffffffffffffffffffff1660045410151561030b57600454604060405190810160405280601e81526020017f46756e64696e6720676f616c20686173206265656e207265616368656421000081525090915091506103b0565b600760009054906101000a90046fffffffffffffffffffffffffffffffff166fffffffffffffffffffffffffffffffff1660045410156103af57600454606060405190810160405280602281526020017f46756e64696e6720676f616c20686173206e6f74206265656e2072656163686581526020017f642100000000000000000000000000000000000000000000000000000000000081525090915091506103b0565b5b9091565b600760009054906101000a90046fffffffffffffffffffffffffffffffff1681565b34600360003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020819055506002805480600101828161042e9190610638565b916000526020600020900160005b33909190916101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555050346004600082825401925050819055505b565b60055481565b6000600060006000600092505b600280549050831015610619576002838154811015156104c057fe5b906000526020600020900160005b9054906101000a900473ffffffffffffffffffffffffffffffffffffffff169150600360008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020549050600081111561060b576000600360008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020819055508173ffffffffffffffffffffffffffffffffffffffff166108fc829081150290604051809050600060405180830381858888f19350505050151561060a5780600360008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020819055506000935061061e565b5b5b82806001019350506104a4565b600193505b50505090565b602060405190810160405280600081525090565b81548183558181151161065f5781836000526020600020918201910161065e9190610664565b5b505050565b61068691905b8082111561068257600081600090555060010161066a565b5090565b905600a165627a7a72305820d32f10829b65f0ccf04d2b024e839643d4a13a177a7d7f519ce0d2b406862c8d0029',
                    gas: '4700000'
                }, function (e, contract) {
                    if (typeof contract.address !== 'undefined') {
                        resolve(new Project(contract.address));
                    }
                }
            );

        });
    }

    constructor(address) {
        this.address = address;
    }

    status() {
        return Project.contract.at(this.address).getfundingstatus.call();
    }

    fund(accountIndex, amount) {
        var account = web3.eth.accounts[accountIndex];
        Project.contract.at(this.address).fund({from: account, value: web3.toWei(amount, 'ether'), gas: 1000000});
    }

    kill(accountIndex) {
        var account = web3.eth.accounts[accountIndex];
        console.log(account);
        Project.contract.at(this.address).kill({from: account, gas: 1000000});
    }

}

module.exports = Project;

Project.contract = web3.eth.contract([{
    "constant": true,
    "inputs": [],
    "name": "fundingEnd",
    "outputs": [{"name": "", "type": "uint256"}],
    "payable": false,
    "type": "function"
}, {
    "constant": false,
    "inputs": [],
    "name": "kill",
    "outputs": [],
    "payable": false,
    "type": "function"
}, {
    "constant": false,
    "inputs": [],
    "name": "getfundingstatus",
    "outputs": [{"name": "", "type": "string"}, {"name": "", "type": "uint256"}],
    "payable": false,
    "type": "function"
}, {
    "constant": true,
    "inputs": [],
    "name": "fundingGoal",
    "outputs": [{"name": "", "type": "uint128"}],
    "payable": false,
    "type": "function"
}, {
    "constant": false,
    "inputs": [],
    "name": "fund",
    "outputs": [],
    "payable": true,
    "type": "function"
}, {
    "constant": true,
    "inputs": [],
    "name": "fundingStart",
    "outputs": [{"name": "", "type": "uint256"}],
    "payable": false,
    "type": "function"
}, {
    "inputs": [{"name": "_name", "type": "string"}, {
        "name": "_fundingStart",
        "type": "uint256"
    }, {"name": "_fundingEnd", "type": "uint256"}, {"name": "_fundingGoal", "type": "uint128"}],
    "payable": false,
    "type": "constructor"
}, {"payable": true, "type": "fallback"}]);
